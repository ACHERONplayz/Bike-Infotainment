<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Bike Infotainment System - MyLink Style</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <style>
        :root {
            --mylink-blue: #00a1de;
            --mylink-dark-bg: #1c1c1e;
            --mylink-dark-gray: #2c2c2e;
            --mylink-med-gray: #3a3a3c;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #000;
            color: #f0f0f0;
            overflow: hidden;
        }
        .infotainment-container {
            width: 100vw;
            height: 100vh;
            background: linear-gradient(135deg, #0a192f 0%, #172a46 100%);
            display: flex;
            flex-direction: column;
            max-width: 800px;
            max-height: 480px;
            margin: auto;
            border-radius: 1rem;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
            position: relative;
        }
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 1.5rem;
            background-color: rgba(0,0,0,0.2);
            flex-shrink: 0;
        }
        .content-area {
            flex-grow: 1;
            position: relative;
            height: 100%;
            overflow: hidden;
        }
        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding: 1.5rem;
            opacity: 0;
            visibility: hidden;
            transform: scale(1.02);
            transition: opacity 0.25s ease-in-out, transform 0.25s ease-in-out;
            background-color: var(--mylink-dark-bg);
            overflow-y: auto;
        }
        .screen.active {
            opacity: 1;
            visibility: visible;
            transform: scale(1);
        }
        
        .dock {
            display: none; /* Hidden by default */
            justify-content: space-around;
            background-color: #111;
            padding: 0.5rem 0;
            border-top: 1px solid #333;
            flex-shrink: 0;
        }
        .app-view-active .dock {
            display: flex; /* Show dock when an app is active */
        }
        .dock-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
            width: 80px;
        }
        .dock-item.active {
            background-color: var(--mylink-blue);
        }
        .dock-item svg {
            width: 28px;
            height: 28px;
            margin-bottom: 0.25rem;
        }
        .dock-item span {
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        /* App-specific styles */
        #nav-screen, #poi-screen, #weather-screen, #youtube-screen { padding: 0; }
        #map, #poi-map, #weather-map { height: 100%; width: 100%; }
        .leaflet-routing-container { display: none; }
        .nav-search-bar { position: absolute; top: 1rem; left: 50%; transform: translateX(-50%); z-index: 999; width: 60%; }
        .nav-search-bar input { width: 100%; padding: 0.75rem 1rem; border-radius: 99px; border: 1px solid var(--mylink-med-gray); background-color: rgba(28, 28, 30, 0.8); backdrop-filter: blur(5px); color: white; }

        #startup-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--mylink-dark-bg); z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.5s ease-out;
        }
        #startup-screen.hidden { opacity: 0; pointer-events: none; }
        
        /* Comms Screen */
        .contact-list { display: flex; flex-direction: column; gap: 0.75rem; }
        .contact-item { background-color: var(--mylink-dark-gray); border-radius: 0.75rem; padding: 1rem; display: flex; justify-content: space-between; align-items: center; }
        .contact-item .name { font-size: 1.2rem; font-weight: 500; }
        .contact-item .actions { display: flex; gap: 1rem; }
        .contact-item .actions a { background-color: var(--mylink-med-gray); padding: 0.5rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; }

        /* Weather Screen */
        #weather-screen { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; padding: 1.5rem; }
        #weather-map-container { border-radius: 0.75rem; overflow: hidden; }
        .weather-details { display: flex; flex-direction: column; gap: 1.5rem; }
        .current-weather-details, .weather-forecast { background-color: var(--mylink-dark-gray); border-radius: 0.75rem; padding: 1rem; }
        
        /* POI Screen */
        .poi-controls { position: absolute; top: 1rem; left: 1rem; z-index: 999; display: flex; gap: 0.5rem; }
        .poi-btn { background-color: rgba(28, 28, 30, 0.8); backdrop-filter: blur(5px); border: 1px solid var(--mylink-med-gray); color: white; padding: 0.5rem 1rem; border-radius: 99px; }
        
        /* Gemini Screen */
        #gemini-screen { display: flex; flex-direction: column; }
        .chat-container { flex-grow: 1; overflow-y: auto; padding-bottom: 1rem; }
        .chat-message { max-width: 80%; padding: 0.75rem 1.25rem; border-radius: 1.25rem; margin-bottom: 0.75rem; line-height: 1.5; }
        .chat-message.user { background-color: var(--mylink-blue); align-self: flex-end; }
        .chat-message.gemini { background-color: var(--mylink-med-gray); align-self: flex-start; }
        .chat-input-form { display: flex; padding-top: 1rem; border-top: 1px solid var(--mylink-med-gray); }
        
        /* Settings Screen */
        .settings-container { width: 100%; max-width: 500px; }
        .settings-item { display: flex; justify-content: space-between; align-items: center; padding: 1rem; background-color: var(--mylink-dark-gray); border-radius: 0.5rem; margin-bottom: 1rem; }
        .settings-item label { font-size: 1.1rem; font-weight: 500; }
        .settings-item select { background-color: #444; border: 1px solid #555; border-radius: 0.25rem; padding: 0.25rem 0.5rem; color: white; }

        /* Menu Screen */
        #menu-screen { display: flex; align-items: center; justify-content: center; }
        .menu-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 2rem; }
        .menu-item { display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; }
        .menu-item .icon-bg { width: 80px; height: 80px; border-radius: 0.75rem; background-color: var(--mylink-dark-gray); display: flex; align-items: center; justify-content: center; margin-bottom: 0.5rem; transition: transform 0.2s; }
        .menu-item:hover .icon-bg { transform: scale(1.1); }
        .menu-item span { font-size: 0.8rem; font-weight: 500; }

        /* Maintenance Screen */
        #maintenance-list { display: flex; flex-direction: column; gap: 1rem; }
        .maintenance-item { background-color: var(--mylink-dark-gray); border-radius: 0.75rem; padding: 1rem; }
        .maintenance-item .progress-bar-bg { background-color: var(--mylink-med-gray); border-radius: 99px; height: 8px; overflow: hidden; }
        .maintenance-item .progress-bar { height: 100%; border-radius: 99px; transition: width 0.5s, background-color 0.5s; }

        /* YouTube Screen */
        #youtube-screen { display: flex; flex-direction: column; }
        #youtube-player-container { flex-grow: 1; background-color: #000; display: flex; align-items: center; justify-content: center; border-radius: 0.5rem; }
        #youtube-player-container iframe { width: 100%; height: 100%; border: none; }
        #youtube-form { display: flex; margin-top: 1rem; }
        #youtube-url-input { flex-grow: 1; background-color: var(--mylink-dark-gray); border: 1px solid var(--mylink-med-gray); color: white; padding: 0.5rem 1rem; border-radius: 99px; }
    </style>
</head>
<body class="flex items-center justify-center">

    <div id="infotainment-container" class="infotainment-container">
        <div id="startup-screen">
            <svg width="80" height="80" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M50 0L96.5926 25V75L50 100L3.4074 75V25L50 0Z" fill="#B8A05A"/>
                <path d="M50 12L87 32V68L50 88L13 68V32L50 12Z" stroke="white" stroke-width="4"/>
                <path d="M30 40H70" stroke="white" stroke-width="4"/>
                <path d="M30 60H70" stroke="white" stroke-width="4"/>
                <path d="M50 30V70" stroke="white" stroke-width="4"/>
            </svg>
            <h2 class="text-2xl font-light mt-4 tracking-wider">MyLink</h2>
        </div>

        <div class="status-bar">
            <div id="timeDisplay" class="text-lg font-semibold">17:18</div>
            <div id="gpsStatus" class="text-sm text-yellow-400 font-semibold"></div>
            <div class="flex items-center gap-4">
                <div id="temperature" class="text-lg font-semibold">22°C</div>
            </div>
        </div>

        <div class="content-area">
            <div id="menu-screen" class="screen">
                <div id="menu-grid" class="menu-grid">
                    <!-- Menu items are rendered here by JS -->
                </div>
            </div>
            <div id="nav-screen" class="screen">
                 <div class="nav-search-bar">
                    <form id="nav-search-form"><input type="text" id="nav-search-input" placeholder="Where to?"></form>
                </div>
                <div id="map"></div>
            </div>
            <div id="music-screen" class="screen flex items-center justify-center gap-8">
                 <img id="album-art-large" src="https://placehold.co/200x200/1c1c1e/3a3a3c?text=Music" class="rounded-lg shadow-lg">
                 <div class="w-64">
                    <h2 id="music-track-title" class="text-2xl font-bold">Not Connected</h2>
                    <p id="music-track-artist" class="text-lg text-gray-400">Connect to phone</p>
                    <div class="w-full bg-gray-600 rounded-full h-1.5 mt-4">
                        <div class="bg-blue-500 h-1.5 rounded-full" style="width: 45%"></div>
                    </div>
                     <div class="flex items-center justify-between text-xs text-gray-400 mt-1">
                        <span>1:21</span>
                        <span>3:05</span>
                    </div>
                    <div class="flex items-center justify-center space-x-6 mt-4">
                        <button id="prev-btn" class="text-gray-300 hover:text-white"><svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20"><path d="M8.445 14.832A1 1 0 0010 14.208V5.792a1 1 0 00-1.555-.832L4.12 8.128a1 1 0 000 1.664l4.325 3.04zM11 5.792v8.416a1 1 0 001.555.832l4.325-3.04a1 1 0 000-1.664l-4.325-3.04A1 1 0 0011 5.792z"/></svg></button>
                        <button id="play-pause-btn" class="p-3 bg-blue-500 rounded-full hover:bg-blue-600 transition-colors"><svg class="w-10 h-10" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8.002v3.996a1 1 0 001.555.832l3.198-2a1 1 0 000-1.664l-3.198-2z" clip-rule="evenodd" /></svg></button>
                        <button id="next-btn" class="text-gray-300 hover:text-white"><svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20"><path d="M11.555 5.168A1 1 0 0010 5.792v8.416a1 1 0 001.555.832l4.325-3.04a1 1 0 000-1.664l-4.325-3.04zM9 5.792V14.208a1 1 0 01-1.555.832L3.12 11.972a1 1 0 010-1.664l4.325-3.04A1 1 0 019 5.792z"/></svg></button>
                    </div>
                 </div>
            </div>
            <div id="comms-screen" class="screen">
                 <h2 class="text-2xl font-bold mb-4">Phone</h2>
                 <div id="contact-list" class="contact-list"></div>
            </div>
             <div id="weather-screen" class="screen">
                <div id="weather-map-container"><div id="weather-map"></div></div>
                <div class="weather-details">
                    <div class="current-weather-details">
                        <p id="weather-temp" class="text-4xl font-bold">--°</p>
                        <p id="weather-desc" class="text-gray-400">Loading...</p>
                    </div>
                    <div class="weather-forecast"><canvas id="forecast-chart"></canvas></div>
                </div>
            </div>
             <div id="poi-screen" class="screen">
                 <!-- POI content -->
            </div>
             <div id="sport-screen" class="screen">
                 <!-- Sport content -->
            </div>
             <div id="gemini-screen" class="screen">
                <div id="chat-container" class="chat-container"></div>
                <form id="chat-form" class="chat-input-form">
                    <input type="text" id="chat-input" placeholder="Ask Gemini..." class="bg-gray-800 border-none rounded-full px-4 py-2 w-full text-white">
                    <button type="submit" class="ml-2 p-2 bg-blue-600 rounded-full"><svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20"><path d="M3.105 3.105a1 1 0 011.414 0L10 8.586l5.48-5.481a1 1 0 111.415 1.414L11.414 10l5.481 5.48a1 1 0 11-1.414 1.415L10 11.414l-5.48 5.481a1 1 0 11-1.415-1.414L8.586 10 3.105 4.52a1 1 0 010-1.414z"/></svg></button>
                </form>
             </div>
             <div id="settings-screen" class="screen">
                <div class="settings-container">
                    <div class="settings-item">
                        <label for="unit-select">Units</label>
                        <select id="unit-select" name="units">
                            <option value="metric">Metric (km, km/h)</option>
                            <option value="imperial">Imperial (mi, mph)</option>
                        </select>
                    </div>
                    <div class="settings-item">
                        <label for="time-format-select">Time Format</label>
                        <select id="time-format-select" name="time-format">
                            <option value="24h">24-Hour</option>
                            <option value="12h">12-Hour</option>
                        </select>
                    </div>
                </div>
             </div>
             <div id="maintenance-screen" class="screen">
                <h2 class="text-2xl font-bold mb-4">Maintenance Log</h2>
                <div id="maintenance-list"></div>
             </div>
             <div id="youtube-screen" class="screen">
                <form id="youtube-form" class="mb-4">
                    <input type="text" id="youtube-url-input" placeholder="Paste YouTube URL..." class="flex-grow bg-gray-800 border-none rounded-full px-4 py-2 text-white">
                </form>
                <div id="youtube-player-container" class="flex-grow bg-black rounded-lg flex items-center justify-content: center;">
                    <p class="text-gray-500">Paste a link to play a video</p>
                </div>
             </div>
        </div>

        <div class="dock">
            <!-- Dock items will be rendered by JS -->
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Element References ---
            const infotainmentContainer = document.getElementById('infotainment-container');
            const startupScreen = document.getElementById('startup-screen');
            const dockContainer = document.querySelector('.dock');
            const screens = document.querySelectorAll('.screen');
            const navSearchForm = document.getElementById('nav-search-form');
            const navSearchInput = document.getElementById('nav-search-input');
            const contactList = document.getElementById('contact-list');
            const menuGrid = document.getElementById('menu-grid');
            const maintenanceList = document.getElementById('maintenance-list');
            const youtubeForm = document.getElementById('youtube-form');
            const youtubeUrlInput = document.getElementById('youtube-url-input');
            const youtubePlayerContainer = document.getElementById('youtube-player-container');
            
            // --- State ---
            let userLocation = null;
            let routingControl = null;
            let synth, confirmSynth;
            let map, weatherMap, forecastChart;
            let totalDistance = 0;

            // --- App Data ---
            const appData = [
                { id: 'nav-screen', name: 'Nav', icon: `<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l5.447 2.724A1 1 0 0021 16.382V5.618a1 1 0 00-1.447-.894L15 7m-6 10v-5.5m0 0l6-3m-6 3l-6-3" /></svg>`},
                { id: 'music-screen', name: 'Media', icon: `<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2z" /></svg>`},
                { id: 'comms-screen', name: 'Phone', icon: `<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" /></svg>`},
                { id: 'weather-screen', name: 'Weather', icon: `<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z" /></svg>`},
                { id: 'maintenance-screen', name: 'Maintenance', icon: `<svg class="w-8 h-8 icon text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899l4-4a4 4 0 005.656 0l4 4a4 4 0 000 5.656l-1.1 1.1m-2.828-2.828l-4.243 4.243"></path></svg>`},
                { id: 'youtube-screen', name: 'YouTube', icon: `<svg fill="currentColor" viewBox="0 0 24 24"><path d="M19.615 3.184c-3.604-.246-11.631-.245-15.23 0C.89 3.43.16 5.44.16 9.998c0 4.558.73 6.568 3.225 6.814 3.6.245 11.626.246 15.23 0 2.495-.246 3.225-2.256 3.225-6.814 0-4.558-.73-6.568-3.225-6.814zM9.935 14.59V5.408l6.155 4.59-6.155 4.592z"/></svg>`},
                { id: 'gemini-screen', name: 'Gemini', icon: `<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" /></svg>`},
                { id: 'settings-screen', name: 'Settings', icon: `<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>`}
            ];

            // --- Initialization ---
            function startApp() {
                startupScreen.classList.add('hidden');
                renderDock();
                renderMenu();
                showScreen('menu-screen');
                initMaps();
                renderContacts();
                loadMaintenanceData();
            }
            setTimeout(startApp, 2000);
            
            // --- Sound Engine ---
            document.body.addEventListener('click', async () => {
                if (!synth) {
                    await Tone.start();
                    synth = new Tone.NoiseSynth({ noise: { type: 'pink' }, envelope: { attack: 0.001, decay: 0.05, sustain: 0 } }).toDestination();
                    confirmSynth = new Tone.FMSynth({ harmonicity: 1.2, modulationIndex: 10, envelope: { attack: 0.001, decay: 0.2, sustain: 0.01, release: 0.1 }, modulationEnvelope: { attack: 0.01, decay: 0.3, sustain: 0, release: 0.1 } }).toDestination();
                }
            }, { once: true });
            function playSound(type) { if (type === 'nav' && synth) synth.triggerAttack(); else if (type === 'confirm' && confirmSynth) confirmSynth.triggerAttackRelease('C3', '8n'); }

            // --- UI Logic ---
            const screenMap = new Map();
            screens.forEach(screen => screenMap.set(screen.id, screen));
            
            function showScreen(screenId) {
                playSound(screenId === 'menu-screen' ? 'nav' : 'confirm');
                infotainmentContainer.classList.toggle('app-view-active', screenId !== 'menu-screen');
                screens.forEach(s => s.classList.remove('active'));
                const newScreen = screenMap.get(screenId);
                if(newScreen) newScreen.classList.add('active');
                
                document.querySelectorAll('.dock-item').forEach(item => item.classList.toggle('active', item.dataset.screen === screenId));
                
                if (screenId === 'nav-screen' && map) setTimeout(() => map.invalidateSize(), 10);
                if (screenId === 'weather-screen' && weatherMap) setTimeout(() => weatherMap.invalidateSize(), 10);
                if (screenId === 'maintenance-screen') updateMaintenanceLog();
            }

            function renderDock() {
                const dockContainer = document.querySelector('.dock');
                dockContainer.innerHTML = ''; // Clear existing
                const homeButton = document.createElement('button');
                homeButton.className = 'dock-item';
                homeButton.dataset.screen = 'menu-screen';
                homeButton.innerHTML = `<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg><span>Home</span>`;
                dockContainer.appendChild(homeButton);
                
                const mainApps = ['nav-screen', 'music-screen', 'comms-screen'];
                appData.filter(app => mainApps.includes(app.id)).forEach(app => {
                    const dockItem = document.createElement('button');
                    dockItem.className = 'dock-item';
                    dockItem.dataset.screen = app.id;
                    dockItem.innerHTML = `${app.icon}<span>${app.name}</span>`;
                    dockContainer.appendChild(dockItem);
                });
                document.querySelectorAll('.dock-item').forEach(item => item.addEventListener('click', () => showScreen(item.dataset.screen)));
            }

            function renderMenu() {
                 appData.forEach(app => {
                    const menuItem = document.createElement('div');
                    menuItem.className = 'menu-item';
                    menuItem.dataset.screen = app.id;
                    menuItem.innerHTML = `<div class="icon-bg">${app.icon}</div><span>${app.name}</span>`;
                    menuGrid.appendChild(menuItem);
                });
                document.querySelectorAll('.menu-item').forEach(item => item.addEventListener('click', () => showScreen(item.dataset.screen)));
            }
            
            // --- Map & Navigation ---
            function initMaps() {
                map = L.map('map', { zoomControl: false, attributionControl: false }).setView([49.3486, 7.5806], 13);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { maxZoom: 19 }).addTo(map);

                weatherMap = L.map('weather-map', { zoomControl: false, attributionControl: false }).setView([49.3486, 7.5806], 8);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png', { maxZoom: 20, subdomains: 'abcd' }).addTo(weatherMap);
                
                if ('geolocation' in navigator) {
                    navigator.geolocation.watchPosition(position => {
                        const { latitude, longitude, speed } = position.coords;
                        userLocation = L.latLng(latitude, longitude);
                        totalDistance += (speed || 0) * 3.6 / 3600; // Update total distance
                        if (!map.getPane('markerPane')) return;
                        if (!routingControl) map.setView(userLocation, 15);
                    });
                }
            }

            // --- Comms App ---
            function renderContacts() {
                const contacts = [
                    { name: 'Jane Doe', phone: '555-123-4567' },
                    { name: 'John Smith', phone: '555-987-6543' },
                    { name: 'Emergency', phone: '911' }
                ];
                contactList.innerHTML = '';
                contacts.forEach(contact => {
                    const item = document.createElement('div');
                    item.className = 'contact-item';
                    item.innerHTML = `
                        <div><p class="name">${contact.name}</p></div>
                        <div class="actions">
                            <a href="tel:${contact.phone}"><svg class="w-6 h-6 text-green-400" fill="currentColor" viewBox="0 0 20 20"><path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"></path></svg></a>
                            <a href="sms:${contact.phone}"><svg class="w-6 h-6 text-blue-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 5v8a2 2 0 01-2 2h-5l-5 4v-4H4a2 2 0 01-2-2V5a2 2 0 012-2h12a2 2 0 012 2zM7 8H5v2h2V8zm2 0h2v2H9V8zm6 0h-2v2h2V8z" clip-rule="evenodd"></path></svg></a>
                        </div>
                    `;
                    contactList.appendChild(item);
                });
            }

            // --- Maintenance Log ---
            let maintenanceData = {};
            const maintenanceTasks = {
                'lube-chain': { name: 'Lube Chain', interval: 250 },
                'check-brakes': { name: 'Check Brakes', interval: 500 },
                'tire-sealant': { name: 'Tire Sealant', interval: 1000 }
            };

            function loadMaintenanceData() {
                const saved = localStorage.getItem('bikeMaintenance');
                if (saved) {
                    maintenanceData = JSON.parse(saved);
                } else {
                    // Initialize with defaults
                    Object.keys(maintenanceTasks).forEach(key => {
                        maintenanceData[key] = { lastReset: 0 };
                    });
                }
                renderMaintenanceLog();
            }

            function saveMaintenanceData() {
                localStorage.setItem('bikeMaintenance', JSON.stringify(maintenanceData));
            }

            function renderMaintenanceLog() {
                maintenanceList.innerHTML = '';
                Object.entries(maintenanceTasks).forEach(([key, task]) => {
                    const item = document.createElement('div');
                    item.className = 'maintenance-item';
                    item.innerHTML = `
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-lg font-semibold">${task.name}</h3>
                            <button data-task="${key}" class="reset-btn bg-blue-600 text-xs px-3 py-1 rounded-full">Reset</button>
                        </div>
                        <div class="progress-bar-bg"><div id="progress-${key}" class="progress-bar"></div></div>
                        <p id="status-${key}" class="text-xs text-gray-400 mt-1"></p>
                    `;
                    maintenanceList.appendChild(item);
                });
                document.querySelectorAll('.reset-btn').forEach(btn => btn.addEventListener('click', (e) => {
                    const taskKey = e.target.dataset.task;
                    maintenanceData[taskKey].lastReset = totalDistance;
                    saveMaintenanceData();
                    updateMaintenanceLog();
                }));
                updateMaintenanceLog();
            }
            
            function updateMaintenanceLog() {
                 Object.entries(maintenanceTasks).forEach(([key, task]) => {
                    const data = maintenanceData[key];
                    if (!data) return; // Fix for undefined data
                    const ridden = totalDistance - data.lastReset;
                    const remaining = Math.max(0, task.interval - ridden);
                    const progress = Math.min(100, (ridden / task.interval) * 100);
                    
                    const progressBar = document.getElementById(`progress-${key}`);
                    const statusText = document.getElementById(`status-${key}`);

                    if(progressBar && statusText) {
                        progressBar.style.width = `${progress}%`;
                        if (progress > 90) progressBar.style.backgroundColor = 'var(--id7-red)';
                        else if (progress > 70) progressBar.style.backgroundColor = '#f59e0b'; // amber-500
                        else progressBar.style.backgroundColor = '#10b981'; // emerald-500
                        
                        statusText.textContent = `Due in ${remaining.toFixed(0)} km. (Interval: ${task.interval} km)`;
                    }
                });
            }
            setInterval(updateMaintenanceLog, 5000); // Update every 5 seconds

            // --- YouTube App ---
            youtubeForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const url = youtubeUrlInput.value;
                const videoId = getYouTubeID(url);
                if (videoId) {
                    youtubePlayerContainer.innerHTML = `<iframe src="https://www.youtube.com/embed/${videoId}?autoplay=1" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
                } else {
                    youtubePlayerContainer.innerHTML = `<p class="text-red-500">Invalid YouTube URL</p>`;
                }
            });

            function getYouTubeID(url) {
                const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
                const match = url.match(regExp);
                return (match && match[2].length === 11) ? match[2] : null;
            }
        });
    </script>
</body>
</html>
